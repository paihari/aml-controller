<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - syntropAI Sentinel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #faf7f2;
            color: #2d2d2d;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
        }
        
        /* Uniform Header Component */
        .header {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0;
            border-bottom: none;
            margin-bottom: 0;
            position: absolute;
            top: 24px;
            right: 24px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .brand img {
            height: 60px;
            width: auto;
            border: 2px solid #000000;
        }
        
        .brand-text {
            font-size: 24px;
            font-weight: 600;
            color: #2d2d2d;
        }
        
        .system-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        
        .status-dot.error {
            background: #ef4444;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .breadcrumb a {
            color: #374151;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover {
            color: #2563eb;
        }
        
        .breadcrumb .separator {
            color: #9ca3af;
            font-weight: 400;
        }
        
        .breadcrumb .current {
            color: #2563eb;
            font-weight: 600;
        }
        
        /* Page Title Section */
        .page-title {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 20px 0 40px 0;
            padding-bottom: 24px;
            border-bottom: 1px solid #e8e1d6;
        }
        
        .page-title img {
            height: 80px;
            width: auto;
            border: 2px solid #000000;
        }
        
        .page-title-content {
            flex: 1;
        }
        
        .page-title h1 {
            font-size: 2.2rem;
            font-weight: 600;
            color: #2d2d2d;
            margin-bottom: 8px;
        }
        
        .page-title p {
            font-size: 1rem;
            color: #666;
        }
        
        /* Search Interface */
        .search-container {
            background: white;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e8e1d6;
        }
        
        .search-header {
            margin-bottom: 24px;
        }
        
        .search-tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            border-bottom: 2px solid #f3f4f6;
        }
        
        .search-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .search-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        
        .search-tab:hover {
            color: #2563eb;
        }
        
        .search-form {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .search-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-btn:hover {
            background: #1d4ed8;
        }
        
        .search-filters {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        /* Results Section */
        .results-container {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e8e1d6;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .results-count {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d2d2d;
        }
        
        .results-export {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .results-export:hover {
            background: #059669;
        }
        
        .results-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .result-item {
            padding: 16px;
            border: 1px solid #e8e1d6;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .result-item:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .result-title {
            font-weight: 600;
            color: #2d2d2d;
        }
        
        .result-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .result-type.alert {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .result-type.transaction {
            background: #f0f9ff;
            color: #0369a1;
        }
        
        .result-type.sanction {
            background: #fefbeb;
            color: #d97706;
        }
        
        .result-details {
            color: #666;
            font-size: 0.9rem;
        }
        
        .no-results {
            text-align: center;
            padding: 48px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 48px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .search-filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page Title Section -->
        <div class="page-title">
            <img src="../images/Brand.svg" alt="syntropAI" />
            <div class="page-title-content">
                <h1>Search Operations</h1>
                <p>Search across alerts, transactions, and sanctions data</p>
            </div>
        </div>
        
        <!-- Uniform Header Component -->
        <header class="header">
            <div class="header-left">
            </div>
            <div class="system-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">System Online</span>
                <div style="font-size: 12px; color: #666; margin-top: 4px;" id="serverUptime">Uptime: -</div>
            </div>
        </header>
        
        <!-- Breadcrumb Navigation -->
        <nav class="breadcrumb" style="margin-bottom: 40px;">
            <a href="/">Home</a>
            <span class="separator">/</span>
            <span class="current">Search</span>
        </nav>
        
        <!-- Search Interface -->
        <div class="search-container">
            <div class="search-header">
                <h2>Search AML Data</h2>
            </div>
            
            <!-- Search Tabs -->
            <div class="search-tabs">
                <button class="search-tab active" data-type="all">All</button>
                <button class="search-tab" data-type="alerts">Alerts</button>
                <button class="search-tab" data-type="transactions">Transactions</button>
                <button class="search-tab" data-type="sanctions">Sanctions</button>
            </div>
            
            <!-- Search Form -->
            <div class="search-form">
                <input type="text" class="search-input" id="searchQuery" placeholder="Search: TXN-123, Russia, John Smith, $10000, SANCTIONS... (Ctrl+K to focus)">
                <button class="search-btn" onclick="performSearch()">🔍 Search</button>
            </div>
            
            <!-- Search Filters -->
            <div class="search-filters">
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <select class="filter-select" id="dateRange">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">Last Week</option>
                        <option value="month">Last Month</option>
                        <option value="year">Last Year</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-select" id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="pending">Pending</option>
                        <option value="resolved">Resolved</option>
                        <option value="blocked">Blocked</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Risk Level</label>
                    <select class="filter-select" id="riskFilter">
                        <option value="all">All Levels</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="results-container">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Enter search terms to begin</div>
                <button class="results-export" onclick="exportResults()" style="display: none;" id="exportBtn">📥 Export Results</button>
            </div>
            
            <div id="searchResults">
                <div class="no-results">
                    <h3>Ready to Search</h3>
                    <p>Use the search form above to find alerts, transactions, and sanctions data.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentSearchType = 'all';
        let searchResults = [];
        const serverStartTime = Date.now();
        
        // Uptime functionality
        function formatUptime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ${hours % 24}h ${minutes % 60}m`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
            return `${seconds}s`;
        }
        
        function updateServerUptime() {
            const uptime = Date.now() - serverStartTime;
            const uptimeString = formatUptime(uptime);
            const uptimeElement = document.getElementById('serverUptime');
            if (uptimeElement) {
                uptimeElement.textContent = `Uptime: ${uptimeString}`;
            }
        }
        
        // Update uptime every second
        setInterval(updateServerUptime, 1000);
        updateServerUptime();
        
        // Search tab functionality
        document.querySelectorAll('.search-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentSearchType = tab.getAttribute('data-type');
            });
        });
        
        // Search functionality
        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const dateRange = document.getElementById('dateRange').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const riskFilter = document.getElementById('riskFilter').value;
            
            if (!query) {
                alert('Please enter search terms');
                return;
            }
            
            // Show loading
            const resultsContainer = document.getElementById('searchResults');
            const resultsCount = document.getElementById('resultsCount');
            const exportBtn = document.getElementById('exportBtn');
            
            resultsCount.textContent = 'Searching...';
            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><br>Searching data...</div>';
            exportBtn.style.display = 'none';
            
            try {
                // Build search parameters
                const params = new URLSearchParams({
                    q: query,
                    type: currentSearchType,
                    date_range: dateRange,
                    status: statusFilter,
                    risk: riskFilter
                });
                
                // Perform search request
                const response = await fetch(`/api/search?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    searchResults = data.results || [];
                    displayResults(searchResults);
                    resultsCount.textContent = `Found ${searchResults.length} result${searchResults.length !== 1 ? 's' : ''}`;
                    
                    if (searchResults.length > 0) {
                        exportBtn.style.display = 'block';
                    }
                } else {
                    throw new Error(data.error || 'Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<div class="no-results"><h3>Search Error</h3><p>Unable to perform search. Please try again.</p></div>';
                resultsCount.textContent = 'Search failed';
            }
        }
        
        function displayResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results"><h3>No Results Found</h3><p>Try different search terms or adjust your filters.</p></div>';
                return;
            }
            
            const resultsList = results.map((result, index) => {
                const typeClass = result.type.toLowerCase();
                const typeDisplay = result.type.charAt(0).toUpperCase() + result.type.slice(1);
                const timestamp = result.timestamp ? new Date(result.timestamp).toLocaleString() : 'N/A';
                const relevanceScore = result.relevance_score || 0;
                
                // Get metadata for enhanced display
                const metadata = result.metadata || {};
                
                let extraInfo = '';
                if (result.type === 'alert') {
                    extraInfo = `
                        <div style="margin-top: 8px; padding: 8px; background: #fef2f2; border-radius: 6px; font-size: 0.85rem;">
                            <strong>Alert Details:</strong><br>
                            • Risk Level: ${metadata.risk_level || 'Medium'}<br>
                            • Alert Type: ${metadata.alert_type || 'AML Alert'}<br>
                            • Amount: $${metadata.amount ? metadata.amount.toLocaleString() : '0'}
                        </div>
                    `;
                } else if (result.type === 'transaction') {
                    extraInfo = `
                        <div style="margin-top: 8px; padding: 8px; background: #f0f9ff; border-radius: 6px; font-size: 0.85rem;">
                            <strong>Transaction Details:</strong><br>
                            • From: ${metadata.sender || 'N/A'}<br>
                            • To: ${metadata.receiver || 'N/A'}<br>
                            • Amount: $${metadata.amount ? metadata.amount.toLocaleString() : '0'}<br>
                            • Status: ${metadata.status || 'Unknown'}
                        </div>
                    `;
                } else if (result.type === 'sanction') {
                    extraInfo = `
                        <div style="margin-top: 8px; padding: 8px; background: #fefbeb; border-radius: 6px; font-size: 0.85rem;">
                            <strong>Sanctions Details:</strong><br>
                            • Entity Type: ${metadata.entity_type || 'Individual'}<br>
                            • Country: ${metadata.country || 'N/A'}<br>
                            • Program: ${metadata.program || 'N/A'}<br>
                            • Source: ${metadata.source || 'OpenSanctions'}
                        </div>
                    `;
                }
                
                return `
                    <div class="result-item" onclick="toggleResultExpansion(${index})">
                        <div class="result-header">
                            <div class="result-title">${result.title}</div>
                            <div class="result-type ${typeClass}">${typeDisplay}</div>
                        </div>
                        <div class="result-details">${result.details}</div>
                        <div style="font-size: 0.8rem; color: #888; margin-top: 4px;">
                            Updated: ${timestamp} ${relevanceScore > 500 ? '🎯' : relevanceScore > 100 ? '✓' : ''}
                        </div>
                        <div id="extraInfo_${index}" style="display: none;">
                            ${extraInfo}
                            <div style="margin-top: 8px; padding: 8px; background: #f9fafb; border-radius: 6px;">
                                <button onclick="copyToClipboard('${result.data?.transaction_id || result.data?.alert_id || result.data?.name || 'N/A'}', event)" 
                                        style="background: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 8px;">
                                    📋 Copy ID
                                </button>
                                <button onclick="showRawData(${index}, event)" 
                                        style="background: #6366f1; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                                    🔍 View Raw Data
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="results-list">${resultsList}</div>`;
            
            // Store results for raw data viewing
            window.currentSearchResults = results;
        }
        
        function exportResults() {
            if (searchResults.length === 0) {
                alert('No results to export');
                return;
            }
            
            // Create CSV data
            const headers = ['Type', 'Title', 'Details', 'Timestamp'];
            const csvData = [headers.join(',')];
            
            searchResults.forEach(result => {
                const row = [
                    result.type,
                    `"${result.title.replace(/"/g, '""')}"`,
                    `"${result.details.replace(/"/g, '""')}"`,
                    result.timestamp || new Date().toISOString()
                ];
                csvData.push(row.join(','));
            });
            
            // Download CSV
            const blob = new Blob([csvData.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `search-results-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        
        // Enhanced interaction functions
        function toggleResultExpansion(index) {
            const extraInfo = document.getElementById(`extraInfo_${index}`);
            if (extraInfo) {
                extraInfo.style.display = extraInfo.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function copyToClipboard(text, event) {
            event.stopPropagation();
            navigator.clipboard.writeText(text).then(() => {
                // Show temporary feedback
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '✅ Copied!';
                button.style.background = '#059669';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#10b981';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy to clipboard');
            });
        }
        
        function showRawData(index, event) {
            event.stopPropagation();
            const result = window.currentSearchResults[index];
            if (result && result.data) {
                const rawDataWindow = window.open('', '_blank', 'width=800,height=600');
                rawDataWindow.document.write(`
                    <html>
                        <head>
                            <title>Raw Data - ${result.title}</title>
                            <style>
                                body { font-family: monospace; padding: 20px; background: #f5f5f5; }
                                pre { background: white; padding: 20px; border-radius: 8px; overflow-x: auto; }
                                h2 { color: #333; margin-bottom: 16px; }
                            </style>
                        </head>
                        <body>
                            <h2>Raw Data: ${result.title}</h2>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        </body>
                    </html>
                `);
            }
        }
        
        // Allow Enter key to trigger search
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+K or Cmd+K to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchQuery').focus();
            }
            
            // ESC to clear search
            if (e.key === 'Escape') {
                document.getElementById('searchQuery').value = '';
                document.getElementById('searchQuery').focus();
            }
        });
    </script>
</body>
</html>