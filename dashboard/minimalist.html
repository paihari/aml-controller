<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AML Dashboard - syntropAI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="../images/brand.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #faf7f2;
            color: #2d2d2d;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
        }
        
        /* Uniform Header Component */
        .header {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0;
            border-bottom: none;
            margin-bottom: 0;
            position: absolute;
            top: 24px;
            right: 24px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .brand img {
            height: 60px;
            width: auto;
        }
        
        .brand-text {
            font-size: 24px;
            font-weight: 600;
            color: #2d2d2d;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .breadcrumb a {
            color: #374151;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover {
            color: #2563eb;
        }
        
        .breadcrumb .separator {
            color: #9ca3af;
            font-weight: 400;
        }
        
        .breadcrumb .current {
            color: #2563eb;
            font-weight: 600;
        }
        
        .system-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }
        
        /* Page Title Section */
        .page-title {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 20px 0 40px 0;
            padding-bottom: 24px;
            border-bottom: 1px solid #e8e1d6;
        }
        
        .page-title img {
            height: 80px;
            width: auto;
            border: 2px solid #000000;
        }
        
        .page-title-content {
            flex: 1;
        }
        
        .page-title h1 {
            font-size: 2.2rem;
            font-weight: 600;
            color: #2d2d2d;
            margin-bottom: 8px;
        }
        
        .page-title p {
            font-size: 1rem;
            color: #666;
        }
        
        /* Standardized Card System */
        .card-primary {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e8e1d6;
        }
        
        .card-secondary {
            background: #ffffff;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e8e1d6;
            margin-bottom: 16px;
        }
        
        /* Unified Button System */
        .btn-primary {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .btn-success {
            background: #059669;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-info {
            background: #06b6d4;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .btn-info:hover {
            background: #0891b2;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        
        .status-dot.error {
            background: #ef4444;
        }
        
        /* Minimal cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: #ffffff;
            border: 1px solid #e8e1d6;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            transition: box-shadow 0.2s ease;
        }
        
        .stat-card:hover {
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #2d2d2d;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        /* Minimal controls */
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #ffffff;
            border: 1px solid #d1c7b8;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #2d2d2d;
            transition: all 0.2s ease;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background: #f5f2ed;
            border-color: #c4b8a5;
        }
        
        .btn.active {
            background: #2d2d2d;
            color: #ffffff;
            border-color: #2d2d2d;
        }
        
        /* Minimal tables */
        .section {
            background: #ffffff;
            border: 1px solid #e8e1d6;
            border-radius: 8px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e8e1d6;
            background: #fbf9f6;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d2d2d;
        }
        
        .section-content {
            padding: 0;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 16px 24px;
            text-align: left;
            border-bottom: 1px solid #f0ebe2;
        }
        
        th {
            background: #fbf9f6;
            font-weight: 600;
            font-size: 14px;
            color: #2d2d2d;
        }
        
        td {
            font-size: 14px;
            color: #444;
        }
        
        tr:hover {
            background: #fcfaf7;
        }
        
        /* Risk score styling */
        .risk-score {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .risk-critical {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .risk-high {
            background: #fff7ed;
            color: #ea580c;
            border: 1px solid #fed7aa;
        }
        
        .risk-medium {
            background: #fefce8;
            color: #ca8a04;
            border: 1px solid #fde047;
        }
        
        /* Chart containers */
        .chart-container {
            padding: 24px;
            height: 300px;
            position: relative;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        /* Loading states */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        /* Progress Bar */
        .progress-container {
            background: #ffffff;
            border: 1px solid #e8e1d6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .progress-text {
            font-weight: 600;
            color: #2d2d2d;
        }
        
        .progress-percent {
            font-weight: 600;
            color: #4caf50;
        }
        
        .progress-bar {
            height: 8px;
            background: #f0ebe2;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-details {
            text-align: center;
            color: #666;
            font-size: 12px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-top: 1px solid #f0ebe2;
            margin-top: 10px;
        }
        
        .pagination button {
            background: #ffffff;
            border: 1px solid #d1c7b8;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #2d2d2d;
            transition: all 0.2s ease;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #f5f2ed;
            border-color: #c4b8a6;
        }
        
        .pagination button:disabled {
            background: #f8f5f0;
            color: #999;
            cursor: not-allowed;
            border-color: #e8e1d6;
        }
        
        .page-size-select, .filter-select {
            background: #ffffff;
            border: 1px solid #d1c7b8;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #2d2d2d;
        }
        
        .count-badge {
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .section-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-under-review {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-failed {
            background: #f5c6cb;
            color: #721c24;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 12px 16px;
            }
        }
        
        /* Minimal animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page Title Section -->
        <div class="page-title">
            <a href="/" style="display: inline-block;">
                <img src="../images/Brand.svg" alt="syntropAI" style="cursor: pointer;" />
            </a>
            <div class="page-title-content">
                <h1>AML Dashboard</h1>
                <p>Real-time Anti-Money Laundering Detection & Monitoring</p>
            </div>
        </div>
        
        <!-- Uniform Header Component -->
        <header class="header">
            <div class="header-left">
            </div>
            <div class="system-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">System Online</span>
                <div style="font-size: 12px; color: #666; margin-top: 4px;" id="serverUptime">Uptime: -</div>
            </div>
        </header>
        
        <!-- Breadcrumb Navigation -->
        <nav class="breadcrumb" style="margin-bottom: 40px;">
            <a href="/">Home</a>
            <span class="separator">/</span>
            <span class="current">AML Dashboard</span>
        </nav>

        <!-- Statistics Cards -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="criticalAlerts">-</div>
                <div class="stat-label">Critical Alerts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highRiskAlerts">-</div>
                <div class="stat-label">High Risk Alerts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="mediumRiskAlerts">-</div>
                <div class="stat-label">Medium Risk Alerts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lowRiskAlerts">-</div>
                <div class="stat-label">Low Risk Alerts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalTransactions">-</div>
                <div class="stat-label">Total Transactions</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <a href="/dashboard/data-generator.html" class="btn">Generate Sample Data</a>
            <button class="btn" id="processBtn" onclick="processTransactions()">Process Pending Transactions</button>
            <button class="btn" onclick="exportData()">Export Results</button>
        </div>

        <!-- Progress Bar for Processing -->
        <div id="progressContainer" class="progress-container" style="display: none;">
            <div class="progress-header">
                <span id="progressText">Processing transactions...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div class="progress-details">
                <small id="progressDetails">Initializing...</small>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="section">
                <div class="section-header">
                    <div class="section-title">Alert Distribution</div>
                </div>
                <div class="chart-container">
                    <canvas id="alertChart"></canvas>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <div class="section-title">Risk Levels</div>
                </div>
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Active Alerts Table -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">Active Alerts</div>
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table id="alertsTable">
                        <thead>
                            <tr>
                                <th>Alert ID</th>
                                <th>Type</th>
                                <th>Risk Score</th>
                                <th>Parties</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="alertsTableBody">
                            <tr>
                                <td colspan="6" class="loading">Loading alerts...</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- Alerts Pagination Controls -->
                    <div class="pagination" id="alertsPaginationControls">
                        <button id="alertsPrevBtn" onclick="changeAlertsPage(-1)" disabled>← Previous</button>
                        <span id="alertsPageInfo">Page 1 of 1</span>
                        <button id="alertsNextBtn" onclick="changeAlertsPage(1)" disabled>Next →</button>
                        <select id="alertsPageSizeSelect" onchange="changeAlertsPageSize()" class="page-size-select">
                            <option value="5">5 per page</option>
                            <option value="10" selected>10 per page</option>
                            <option value="25">25 per page</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions Table -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    Transactions 
                    <span id="transactionCount" class="count-badge"></span>
                </div>
                <div class="section-controls">
                    <select id="statusFilter" onchange="filterTransactions()" class="filter-select">
                        <option value="">All Status</option>
                        <option value="PENDING">Pending</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="UNDER_REVIEW">Under Review</option>
                        <option value="FAILED">Failed</option>
                    </select>
                </div>
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Amount</th>
                                <th>Beneficiary</th>
                                <th>Country</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <tr>
                                <td colspan="7" class="loading">Loading transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- Pagination Controls -->
                    <div class="pagination" id="paginationControls">
                        <button id="prevBtn" onclick="changePage(-1)" disabled>← Previous</button>
                        <span id="pageInfo">Page 1 of 1</span>
                        <button id="nextBtn" onclick="changePage(1)" disabled>Next →</button>
                        <select id="pageSizeSelect" onchange="changePageSize()" class="page-size-select">
                            <option value="10">10 per page</option>
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = window.location.origin.includes('localhost') 
            ? 'http://localhost:5001/api'
            : `${window.location.origin}/api`;

        let alertChart, riskChart;
        
        // Pagination variables
        let currentPage = 1;
        let pageSize = 10;
        let totalTransactions = 0;
        let allTransactions = [];
        let filteredTransactions = [];
        
        // Alerts pagination variables
        let currentAlertsPage = 1;
        let alertsPageSize = 10;
        let totalAlerts = 0;
        let allAlerts = [];
        let currentStatusFilter = '';

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadDashboardData();
            updateServerUptime();
            
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
            
            // Update uptime every 5 seconds
            setInterval(updateServerUptime, 5000);
        });

        // Initialize Charts with minimal style
        function initializeCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12
                            },
                            color: '#666'
                        }
                    }
                }
            };

            // Alert Distribution Chart
            const alertCtx = document.getElementById('alertChart').getContext('2d');
            alertChart = new Chart(alertCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6'],
                        borderWidth: 0
                    }]
                },
                options: commonOptions
            });

            // Risk Distribution Chart
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            riskChart = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e'],
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#666',
                                font: { size: 11 }
                            },
                            grid: {
                                color: '#f0ebe2'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#666',
                                font: { size: 11 }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Load Dashboard Data
        async function loadDashboardData() {
            try {
                updateStatus('online');
                
                // Use the comprehensive dashboard data endpoint
                const dashboardResponse = await fetch(`${API_BASE}/dashboard/data`);
                
                if (dashboardResponse && dashboardResponse.ok) {
                    const dashboardData = await dashboardResponse.json();
                    
                    // Update all components with the comprehensive data
                    updateStatistics(dashboardData.statistics);
                    updateAlerts(dashboardData.alerts, dashboardData.alert_typologies, dashboardData.statistics.alerts_by_risk);
                    await loadTransactionsData();
                } else {
                    // Fallback to individual endpoints if dashboard endpoint fails
                    const [healthResponse, statsResponse, alertsResponse, transactionsResponse] = await Promise.all([
                        fetch(`${API_BASE}/health`).catch(() => null),
                        fetch(`${API_BASE}/statistics`).catch(() => null),
                        fetch(`${API_BASE}/alerts?limit=20`).catch(() => null),
                        fetch(`${API_BASE}/transactions?limit=10`).catch(() => null)
                    ]);

                    // Update statistics
                    if (statsResponse && statsResponse.ok) {
                        const stats = await statsResponse.json();
                        updateStatistics(stats.data || stats);
                    }

                    // Update alerts
                    if (alertsResponse && alertsResponse.ok) {
                        const alerts = await alertsResponse.json();
                        updateAlerts(alerts.data || alerts);
                    }

                    // Update transactions
                    await loadTransactionsData();
                }

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                updateStatus('error');
            }
        }

        // Server start time for uptime calculation
        const serverStartTime = Date.now();
        
        // Update Statistics
        function updateStatistics(stats) {
            // Update risk-based alert counts
            const riskLevels = stats.alerts_by_risk || {};
            document.getElementById('criticalAlerts').textContent = riskLevels.Critical || 0;
            document.getElementById('highRiskAlerts').textContent = riskLevels.High || 0;
            document.getElementById('mediumRiskAlerts').textContent = riskLevels.Medium || 0;
            document.getElementById('lowRiskAlerts').textContent = riskLevels.Low || 0;
            
            // Update transaction count
            document.getElementById('totalTransactions').textContent = stats.total_transactions || 0;
        }
        
        // Update server uptime
        function updateServerUptime() {
            const uptime = Date.now() - serverStartTime;
            const uptimeString = formatUptime(uptime);
            document.getElementById('serverUptime').textContent = `Uptime: ${uptimeString}`;
        }
        
        // Format uptime duration
        function formatUptime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
                return `${days}d ${hours % 24}h ${minutes % 60}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Update Alerts Table and Chart
        function updateAlerts(alerts, preCalculatedTypologies = null, preCalculatedRisk = null) {
            // Store all alerts for pagination
            allAlerts = alerts || [];
            totalAlerts = allAlerts.length;
            
            let alertTypes = {};
            let riskLevels = { Critical: 0, High: 0, Medium: 0, Low: 0 };

            if (!alerts || alerts.length === 0) {
                const tbody = document.getElementById('alertsTableBody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No active alerts</td></tr>';
                updateAlertsControls();
                updateCharts({}, riskLevels);
                return;
            }

            // Use pre-calculated typologies if available, otherwise calculate
            if (preCalculatedTypologies) {
                alertTypes = Object.keys(preCalculatedTypologies).reduce((acc, key) => {
                    acc[formatTypology(key)] = preCalculatedTypologies[key];
                    return acc;
                }, {});
            }

            // Use pre-calculated risk data if available
            if (preCalculatedRisk) {
                riskLevels = { Critical: 0, High: 0, Medium: 0, Low: 0, ...preCalculatedRisk };
            }

            // Calculate pagination and display current page
            displayAlertsPage();
            updateAlertsControls();

            // Update charts with data
            updateCharts(alertTypes, riskLevels);
        }
        
        // Display current page of alerts
        function displayAlertsPage() {
            const tbody = document.getElementById('alertsTableBody');
            const startIndex = (currentAlertsPage - 1) * alertsPageSize;
            const endIndex = startIndex + alertsPageSize;
            const pageAlerts = allAlerts.slice(startIndex, endIndex);
            
            if (pageAlerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No alerts on this page</td></tr>';
                return;
            }

            tbody.innerHTML = pageAlerts.map(alert => {
                // Get risk score for styling
                const riskScore = alert.risk_score || 0;
                const riskClass = riskScore >= 0.9 ? 'risk-critical' : 
                                 riskScore >= 0.7 ? 'risk-high' : 'risk-medium';
                
                // Extract party information from evidence
                const evidence = alert.evidence || {};
                const partyName = evidence.party_name || evidence.beneficiary_name || evidence.watchlist_name || '-';
                const amount = evidence.amount || evidence.transaction_amount || '-';
                
                return `
                    <tr>
                        <td><code>${alert.alert_id}</code></td>
                        <td>${formatTypology(alert.typology)}</td>
                        <td><span class="risk-score ${riskClass}">${Math.round(riskScore * 100)}%</span></td>
                        <td>${partyName}</td>
                        <td>${amount !== '-' ? formatCurrency(amount) : '-'}</td>
                        <td>${formatDate(alert.created_at || new Date().toISOString())}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Update alerts pagination controls
        function updateAlertsControls() {
            const totalPages = Math.ceil(totalAlerts / alertsPageSize);
            
            document.getElementById('alertsPageInfo').textContent = 
                `Page ${currentAlertsPage} of ${totalPages} (${totalAlerts} alerts)`;
            
            document.getElementById('alertsPrevBtn').disabled = currentAlertsPage <= 1;
            document.getElementById('alertsNextBtn').disabled = currentAlertsPage >= totalPages;
        }
        
        // Change alerts page
        function changeAlertsPage(direction) {
            const totalPages = Math.ceil(totalAlerts / alertsPageSize);
            currentAlertsPage += direction;
            
            if (currentAlertsPage < 1) currentAlertsPage = 1;
            if (currentAlertsPage > totalPages) currentAlertsPage = totalPages;
            
            displayAlertsPage();
            updateAlertsControls();
        }
        
        // Change alerts page size
        function changeAlertsPageSize() {
            alertsPageSize = parseInt(document.getElementById('alertsPageSizeSelect').value);
            currentAlertsPage = 1; // Reset to first page
            displayAlertsPage();
            updateAlertsControls();
        }

        // Update Transactions Table
        function updateTransactions(transactions) {
            const tbody = document.getElementById('transactionsTableBody');

            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No recent transactions</td></tr>';
                return;
            }

            tbody.innerHTML = transactions.map(tx => {
                const status = tx.status || 'PROCESSED';
                const statusColor = {
                    'COMPLETED': '#22c55e',
                    'PROCESSED': '#22c55e', 
                    'PENDING': '#f59e0b',
                    'FAILED': '#ef4444',
                    'UNDER_REVIEW': '#6b7280'
                }[status] || '#22c55e';
                
                return `
                    <tr>
                        <td><code>${tx.transaction_id}</code></td>
                        <td>${formatCurrency(tx.amount)}</td>
                        <td>${tx.account_id || 'N/A'} (${tx.origin_country})</td>
                        <td>${tx.beneficiary_name} (${tx.beneficiary_country})</td>
                        <td>${formatDate(tx.transaction_date)}</td>
                        <td><span style="color: ${statusColor}; font-weight: 500;">${status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Update Charts
        function updateCharts(alertTypes, riskLevels) {
            // Update alert distribution chart
            alertChart.data.labels = Object.keys(alertTypes);
            alertChart.data.datasets[0].data = Object.values(alertTypes);
            alertChart.update();

            // Update risk level chart
            riskChart.data.datasets[0].data = Object.values(riskLevels);
            riskChart.update();
        }

        // Utility Functions
        function updateStatus(status) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (status === 'online') {
                dot.className = 'status-dot';
                text.textContent = 'System Online';
            } else {
                dot.className = 'status-dot error';
                text.textContent = 'System Error';
            }
        }

        function formatTypology(typology) {
            // Handle the new R1_, R2_, etc. format
            const cleanTypology = typology
                .replace(/^R\d+_/, '') // Remove R1_, R2_ prefixes
                .replace(/_/g, ' ')
                .toLowerCase()
                .replace(/\b\w/g, l => l.toUpperCase());
            
            // Map specific cases for better readability
            const typeMap = {
                'Sanctions Match': 'Sanctions Match',
                'High Risk Corridor': 'High Risk Geography',
                'Round Trip': 'Round Trip Transaction',
                'Structuring': 'Structuring Pattern',
                'Velocity': 'Velocity Anomaly'
            };
            
            return typeMap[cleanTypology] || cleanTypology;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Control Functions
        function goToMainDashboard() {
            window.location.href = '/';
        }

        async function initializeData() {
            try {
                const response = await fetch(`${API_BASE}/generate/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ count: 10 })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const message = `Generated ${result.generated_count || 0} transactions in PENDING status:\n` +
                                  `📝 Stored: ${result.stored_count || 0}\n` +
                                  `⏳ Status: Ready for processing`;
                    alert(message);
                    await loadDashboardData();
                } else {
                    const error = await response.json();
                    alert(`Failed to generate data: ${error.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert('Failed to generate data');
            }
        }

        async function processTransactions() {
            try {
                // Get pending transactions count first
                const pendingResponse = await fetch(`${API_BASE}/transactions?status=PENDING`);
                if (!pendingResponse.ok) {
                    alert('Failed to check pending transactions');
                    return;
                }
                
                const pendingData = await pendingResponse.json();
                const pendingCount = pendingData.count || 0;
                
                if (pendingCount === 0) {
                    alert('No pending transactions to process');
                    return;
                }
                
                // Show progress bar and disable button
                showProgressBar();
                const processBtn = document.getElementById('processBtn');
                processBtn.disabled = true;
                processBtn.textContent = 'Processing...';
                
                // Simulate progress updates
                updateProgress(0, 'Initializing AML engine...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateProgress(25, `Processing ${pendingCount} pending transactions...`);
                await new Promise(resolve => setTimeout(resolve, 300));
                
                updateProgress(50, 'Running sanctions screening...');
                await new Promise(resolve => setTimeout(resolve, 400));
                
                updateProgress(75, 'Analyzing risk patterns...');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Process pending transactions through AML detection
                const response = await fetch(`${API_BASE}/transactions/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                updateProgress(90, 'Finalizing results...');
                
                if (response.ok) {
                    const result = await response.json();
                    updateProgress(100, 'Processing complete!');
                    
                    const message = `${result.message || 'Processed transactions'}\n` +
                                  `✅ Completed: ${result.results?.completed || 0}\n` +
                                  `⚠️  Under Review: ${result.results?.under_review || 0}\n` +
                                  `🎯 Plane Items: ${result.plane_integration?.items_created || 0}`;
                    
                    // Hide progress bar after a short delay
                    setTimeout(() => {
                        hideProgressBar();
                        alert(message);
                    }, 1000);
                    
                    // Reload dashboard data
                    await loadDashboardData();
                } else {
                    const error = await response.json();
                    hideProgressBar();
                    alert(`Failed to process transactions: ${error.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                hideProgressBar();
                alert(`Error processing transactions: ${error.message}`);
            } finally {
                // Re-enable button
                const processBtn = document.getElementById('processBtn');
                processBtn.disabled = false;
                processBtn.textContent = 'Process Pending Transactions';
            }
        }

        function exportData() {
            // Simple CSV export of current alerts
            const table = document.getElementById('alertsTable');
            let csv = '';
            
            for (let row of table.rows) {
                const rowData = Array.from(row.cells).map(cell => cell.textContent);
                csv += rowData.join(',') + '\n';
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'aml-alerts.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Progress bar functions
        function showProgressBar() {
            document.getElementById('progressContainer').style.display = 'block';
        }
        
        function hideProgressBar() {
            document.getElementById('progressContainer').style.display = 'none';
        }
        
        function updateProgress(percent, message) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressDetails').textContent = message;
        }

        // Pagination functions
        function loadTransactionsWithPagination() {
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            displayTransactions(paginatedTransactions);
            updatePaginationControls();
        }
        
        function displayTransactions(transactions) {
            const tbody = document.getElementById('transactionsTableBody');
            const countBadge = document.getElementById('transactionCount');
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No transactions found</td></tr>';
                countBadge.textContent = '0';
                return;
            }
            
            countBadge.textContent = filteredTransactions.length;
            
            tbody.innerHTML = transactions.map(tx => {
                const statusClass = `status-${tx.status.toLowerCase().replace('_', '-')}`;
                return `
                    <tr>
                        <td><code>${tx.transaction_id.substring(0, 12)}...</code></td>
                        <td><strong>$${parseFloat(tx.amount || 0).toLocaleString()}</strong></td>
                        <td>${tx.beneficiary_name || 'N/A'}</td>
                        <td><span class="country-flag">${tx.beneficiary_country || 'N/A'}</span></td>
                        <td>${tx.transaction_date || 'N/A'}</td>
                        <td><span class="status-badge ${statusClass}">${tx.status}</span></td>
                        <td>${tx.transaction_type || 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredTransactions.length / pageSize);
            
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(filteredTransactions.length / pageSize);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadTransactionsWithPagination();
            }
        }
        
        function changePageSize() {
            const select = document.getElementById('pageSizeSelect');
            pageSize = parseInt(select.value);
            currentPage = 1; // Reset to first page
            loadTransactionsWithPagination();
        }
        
        function filterTransactions() {
            const select = document.getElementById('statusFilter');
            currentStatusFilter = select.value;
            currentPage = 1; // Reset to first page
            
            if (currentStatusFilter) {
                filteredTransactions = allTransactions.filter(tx => tx.status === currentStatusFilter);
            } else {
                filteredTransactions = [...allTransactions];
            }
            
            loadTransactionsWithPagination();
        }
        
        // Update the loadDashboardData function to use pagination
        async function loadTransactionsData() {
            try {
                const response = await fetch(`${API_BASE}/transactions?limit=1000`);
                if (response.ok) {
                    const data = await response.json();
                    allTransactions = data.data || [];
                    
                    // Apply current filter
                    if (currentStatusFilter) {
                        filteredTransactions = allTransactions.filter(tx => tx.status === currentStatusFilter);
                    } else {
                        filteredTransactions = [...allTransactions];
                    }
                    
                    // Reset to first page
                    currentPage = 1;
                    loadTransactionsWithPagination();
                } else {
                    document.getElementById('transactionsTableBody').innerHTML = 
                        '<tr><td colspan="7" class="loading">Failed to load transactions</td></tr>';
                }
            } catch (error) {
                document.getElementById('transactionsTableBody').innerHTML = 
                    '<tr><td colspan="7" class="loading">Error loading transactions</td></tr>';
            }
        }
    </script>
</body>
</html>